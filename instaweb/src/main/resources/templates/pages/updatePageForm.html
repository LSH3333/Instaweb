<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Page Update</title>

</head>

<body>

<div>
    <form th:object="${form}" method="post">
        <!-- type="hidden" 으로 안넘겨주면 null 됨 -->
        <input type="hidden" th:field="*{id}" />
        <input type="hidden" th:field="*{createdTime}" />
        <!-- 제목 -->
        <div>
            <label th:for="title">제목</label>
            <input type="text" th:field="*{title}" placeholder="제목을 입력하세요" />
        </div>
        <!-- 내용 -->
        <div>
            <label th:for="content">내용</label>
            <textarea cols="50" rows="10" th:field="*{content}" placeholder="내용을 입력하세요"></textarea>
        </div>

        <!-- 이미지, byte 배열 형의 이미지를 generateBase64Image() 로 변환 후 디스플레이  -->
        <div id="imgContainer">
            <!-- <tr th:each="image : *{byteImages}">
                <td>
                    <p th:text="${image.id}"></p>
                    <img th:id="|imgId${image.id}|"
                         th:src="${'data:image/jpeg;charset=utf-8;base64,' + image.generateBase64Image()}" alt="">
                </td>
            </tr> -->
        </div>
        
        <button id="submitBtn" type="submit">수정</button>
    </form>
</div>


<script type="text/javascript">

    // 서버에서 데이터 처리 후 (map 형식으로?), JSON 으로 리턴해야할듯
    var xhr = new XMLHttpRequest();
    var idAndImagesrc = new Map();
    var pageID = "[[${form.id}]]";
    var imgContainer = document.getElementById("imgContainer");
    

    window.onload = function() {
        // 페이지에 저장되어 있는 모든 이미지들 요청 
        xhr.open('GET', '/pages/requestImages?id=' + pageID.toString(), true);
        // 순환참조 에러 발생, dto 사용 or 
        /**
         * 발생하게된 주원인은 '양방향 매핑'이기도 하지만, 더 정확하게는 Entity 자체를 response로 리턴한데에 있다. 
         * entity 자체를 return 하지 말고, DTO 객체를 만들어 필요한 데이터만 옮겨담아 Client로 리턴하면 순환 참조 관련 문제는 애초에 방지 할 수 있다.
         * 
         * */
        xhr.send();
    };

    // ajax response 로 가져온 이미지들 엘레먼트로 만들어서 디스플레이 
    var imgInputEleList = [] 
    xhr.onreadystatechange = function() {
        if(xhr.readyState == XMLHttpRequest.DONE) {
            if(xhr.status == 200) {
                
                let data = JSON.parse(xhr.responseText);
                let imgIdx = 0;
                
                for(imgIdx = 0; imgIdx < data.length; imgIdx++) {
                    let divEle = document.createElement('div');
                    // <p>
                    let pEle = document.createElement('p');
                    pEle.innerHTML = data[imgIdx].id.toString();        
                    // <img> 
                    let imgEle = document.createElement('img');
                    imgEle.id = imgIdx;
                    imgEle.src = 'data:image/jpeg;charset=utf-8;base64,' + data[imgIdx].base64Image;
                    imgEle.classList.add('added-img');
                    // <input> 이미지 클릭 시 파일 선택하도록 
                    let inputEle = document.createElement('input');
                    inputEle.id = imgIdx;
                    inputEle.type = "file";
                    inputEle.style = "display:none;";             
                    inputEle.classList.add('added-input')       
                    /**
                     * <div id="imgContainer">
                     *  <div>
                     *   <p></p>
                     *   <img>
                     *   <input>    
                     *  </div>
                     * </div>
                     * */
                    divEle.appendChild(pEle);
                    divEle.appendChild(imgEle);
                    divEle.appendChild(inputEle);
                    imgContainer.appendChild(divEle);                    
                    imgInputEleList.push([imgEle, inputEle])
                }
                
            }
        }
    }
    
    // imgContainer 하위 <img>에 eventListener  
    imgContainer.addEventListener('click', function (e) {
        if (e.target.classList.contains('added-img')) {
            var fileInput = imgInputEleList[e.target.id][1];
            fileInput.click();
        }    
    });

    // imgContainer 하위 <input>에 eventListner 
    imgContainer.addEventListener('change', function(e) {
        // <input> 에 변경 발생시 변경한 이미지로 디스플레이 
        if(e.target.classList.contains('added-input')) {
            var imgEle = imgInputEleList[e.target.id][0];
            imgEle.src = URL.createObjectURL(e.target.files[0]);
        }
    });

    // submit 버튼 클릭 시 
    document.getElementById("submitBtn").addEventListener('click', function() {
        var sendData = [];
        imgInputEleList.map((x) => {
            sendData.push(x[0].src);
        });

        console.log("sendData");
        xhr.open('POST', '/pages/editImages', true);
        // xhr.setRequestHeader('Content-Type', 'text/plain;charset=UTF-8');
        xhr.send(sendData.join(','));
    });

    
</script>

</body>

</html>