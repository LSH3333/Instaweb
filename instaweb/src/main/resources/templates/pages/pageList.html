<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Page List</title>

    <style>
        html,
        body {
            margin: 0;
        }
    </style>
    
    <!-- page block style -->
    <link rel="stylesheet" type="text/css" href="/css/pageBlock.css" th:href="@{/css/pageBlock.css}">

    <script type="text/javascript">

        let memberId = "[[${memberId}]]";

        // ajax request
        var xhr = new XMLHttpRequest();
        let beginIdx = 0, cnt = 10;

        xhr.onreadystatechange = function () {
            if (xhr.readyState == XMLHttpRequest.DONE) {
                if (xhr.status == 200) {
                    // 스크롤 웹페이지 끝에 도달시 beginIdx 부터 cnt 개의 페이지 가져옴 
                    var contentContainer = document.getElementById('contentContainer');
                    // response from "/pages/ajaxReq" 
                    // Map<String, List<>> 의 형태로 리턴받음
                    var data = JSON.parse(xhr.responseText);

                    // response로 받은 page와 image들로 html 객체 만듦
                    for (let i = 0; i < data.pages.length; i++) {
                        let pageBlock = document.createElement('div');
                        pageBlock.classList.add('pageBlock');

                        // image
                        let aElement = document.createElement('a');
                        aElement.classList.add('imgBlock');
                        aElement.href = '/' + data.pages[i].memberId + '/pages/' + data.pages[i].id;
                        let imgElement = document.createElement('img');
                        imgElement.src = 'data:image/jpeg;charset=utf-8;base64,' + data.images[i];
                        aElement.appendChild(imgElement)

                        // title and content container 
                        let divEle = document.createElement('div');
                        divEle.classList.add('titleAndContentContainer');

                        let h2Element = document.createElement('h2');
                        h2Element.classList.add('title')
                        let h2InnerAEle = document.createElement('a');
                        h2InnerAEle.innerText = data.pages[i].title;
                        h2InnerAEle.href = '/' + data.pages[i].memberId + '/pages/' + data.pages[i].id;
                        h2Element.appendChild(h2InnerAEle);

                        let contentAele = document.createElement('a');
                        contentAele.classList.add('content');
                        contentAele.href = '/' + data.pages[i].memberId + '/pages/' + data.pages[i].id;
                        let aInnerDiv = document.createElement('div');                        
                        aInnerDiv.innerHTML = data.pages[i].content;
                        contentAele.appendChild(aInnerDiv);

                        // content footer 
                        let contentFooter = document.createElement('div'); 
                        contentFooter.classList.add('contentFooter');                      
                        let memberName = document.createElement('p');
                        memberName.classList.add('memberName');
                        memberName.innerHTML = data.pages[i].memberName;
                        let delimeter = document.createElement('p');
                        delimeter.classList.add('delimeter');
                        delimeter.innerHTML = '|';
                        
                        let createdTime = document.createElement('p');
                        createdTime.classList.add('createdTime');
                        const date = new Date(data.pages[i].createdTime);
                        const datePart = date.toISOString().split('T')[0];
                        const timePart = date.toTimeString().split(' ')[0];
                        createdTime.innerHTML = datePart + '. ' + timePart;

                        contentFooter.appendChild(memberName);
                        contentFooter.appendChild(delimeter);
                        contentFooter.appendChild(createdTime);

                        divEle.appendChild(h2Element);
                        divEle.appendChild(contentAele);
                        divEle.appendChild(contentFooter);

                        pageBlock.appendChild(aElement);
                        pageBlock.appendChild(divEle);

                        contentContainer.appendChild(pageBlock);
                    }

                } else {
                    console.error("error");
                }
            }
        }

        // infinite scroll
        window.addEventListener('scroll', function () {
            if (window.innerHeight + window.scrollY + 5 >= document.body.offsetHeight) {
                // 이전 request 에 대한 게시글들 로딩 완료된 이후에만 또 다른 request 보냄
                if (xhr.readyState == XMLHttpRequest.DONE) {
                    if (xhr.status == 200) {
                        xhr.open('GET', '/pages/ajaxReq?beginIdx=' + beginIdx.toString() + '&cnt=' + cnt.toString(), true);
                        beginIdx += cnt;
                        xhr.send();
                    }
                }
            }
        })

        // 최초 페이지 로드 완료시 페이지 idx=0 부터 cnt=10 개 로드
        window.onload = function () {
            xhr.open('GET', '/pages/ajaxReq?beginIdx=' + beginIdx.toString() + '&cnt=' + cnt.toString() + '&memberId=' + memberId.toString(), true);
            beginIdx += cnt;
            xhr.send();
        };

    </script>
</head>

<body>

    <!-- side tab fragment -->
    <div th:replace="fragment/side-tab :: side-tab"></div>

    <!-- Page 들 ajax 에 의해 로드됨 -->
    <div class="contents" style="min-height: 700px; margin-left: 245px; padding:0 5px;">
        <p><a th:if="${loggedIn}" href="/pages/new">글쓰기</a></p>
        <div id="contentContainer">
        </div>
    </div>

    <!-- footer -->
    <footer th:replace="fragment/footer :: footer"></footer>

</body>

</html>